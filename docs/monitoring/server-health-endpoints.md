# Uptime Kuma Health Endpoint Configuration Guide

This guide provides the configuration details for setting up Uptime Kuma monitors for all RSS Reader health endpoints.

## Health Endpoints Overview

All health endpoints return standardized JSON responses with the following structure:

```json
{
  "status": "healthy|degraded|unhealthy|unknown",
  "service": "service-name",
  "uptime": 12345,
  "lastActivity": "2025-01-26T10:00:00Z",
  "errorCount": 0,
  "dependencies": {
    "database": "healthy",
    "oauth": "healthy"
  },
  "performance": {
    "avgSyncTime": 250,
    "avgDbQueryTime": 45,
    "avgApiCallTime": 350
  }
}
```

## Monitor Configuration

### 1. Production App Health

- **Monitor Type**: HTTP(s)
- **Friendly Name**: RSS Reader Production
- **URL**: `http://localhost:3147/reader/api/health/app`
- **Method**: GET
- **Heartbeat Interval**: 60 seconds
- **Retries**: 3
- **Retry Interval**: 60 seconds
- **Accepted Status Codes**: 200-299
- **Tags**: production, app

**Advanced Settings**:

- Enable "Parse Response (JSON)"
- Success condition: `json.status === "healthy" || json.status === "degraded"`

### 2. Development App Health

- **Monitor Type**: HTTP(s)
- **Friendly Name**: RSS Reader Development
- **URL**: `http://localhost:3000/reader/api/health/app`
- **Method**: GET
- **Heartbeat Interval**: 300 seconds (5 minutes)
- **Retries**: 2
- **Retry Interval**: 60 seconds
- **Accepted Status Codes**: 200-299
- **Tags**: development, app

**Advanced Settings**:

- Enable "Parse Response (JSON)"
- Success condition: `json.status === "healthy" || json.status === "degraded"`

### 3. Bi-directional Sync Server Health

- **Monitor Type**: HTTP(s)
- **Friendly Name**: RSS Sync Server
- **URL**: `http://localhost:3001/server/health`
- **Method**: GET
- **Heartbeat Interval**: 60 seconds
- **Retries**: 3
- **Retry Interval**: 60 seconds
- **Accepted Status Codes**: 200-299
- **Tags**: sync, server

**Advanced Settings**:

- Enable "Parse Response (JSON)"
- Success condition: `json.status === "healthy" || json.status === "degraded"`

### 4. Cron Service Health

- **Monitor Type**: HTTP(s)
- **Friendly Name**: RSS Sync Cron
- **URL**: `http://localhost:3147/reader/api/health/cron`
- **Method**: GET
- **Heartbeat Interval**: 300 seconds (5 minutes)
- **Retries**: 2
- **Retry Interval**: 60 seconds
- **Accepted Status Codes**: 200-299
- **Tags**: cron, sync

**Advanced Settings**:

- Enable "Parse Response (JSON)"
- Success condition: `json.status === "healthy" || json.status === "degraded"`

## Monitors to Remove

Based on our implementation, the following monitors should be removed as they're redundant:

1. **Production Port** (TCP Port 3147) - Redundant with Production App monitor
2. **Sync Port** (TCP Port 3000/3001) - Redundant with Sync Server monitor

## Alert Configuration

### Webhook Integration

For critical failures that the monitor-services.sh script can't handle:

1. Create a webhook notification:

   - **Webhook URL**: `http://localhost:3147/reader/api/webhooks/uptime-kuma-recovery`
   - **Request Method**: POST
   - **Content Type**: application/json
   - **Request Body**:

   ```json
   {
     "monitor": "{monitorJSON}",
     "heartbeat": "{heartbeatJSON}",
     "msg": "{msg}"
   }
   ```

2. Apply webhook to monitors:
   - Production App Health: Enable for DOWN events only
   - Sync Server Health: Enable for DOWN events only
   - Cron Service Health: Enable for DOWN events only

### Push Notifications

The cron service already sends push notifications to Uptime Kuma. Ensure the push monitor is configured:

- **Monitor Type**: Push
- **Friendly Name**: RSS Cron Push
- **Push URL**: (Generated by Uptime Kuma)
- **Heartbeat Interval**: 43200 seconds (12 hours)

## Dashboard Organization

Create a status page with the following groups:

1. **Core Services**

   - RSS Reader Production
   - RSS Sync Server

2. **Development**

   - RSS Reader Development

3. **Background Jobs**
   - RSS Sync Cron

## Monitoring Best Practices

1. **Response Time Alerts**: Set up notifications if response time exceeds:

   - App endpoints: > 1000ms
   - Sync server: > 500ms
   - Cron endpoint: > 200ms

2. **Error Count Monitoring**: Use JSON parsing to alert when:

   - `json.errorCount > 10` (last hour)
   - `json.dependencies.database === "unhealthy"`
   - `json.performance.avgDbQueryTime > 500`

3. **Uptime Tracking**: Monitor the `json.uptime` field to detect recent restarts:
   - Alert if uptime < 300 seconds (5 minutes) - may indicate crash loops

## Testing the Configuration

After setting up each monitor:

1. Click "Test" to verify connectivity
2. Check that JSON parsing works correctly
3. Verify the success condition evaluates properly
4. Test webhook delivery (if configured)

## Maintenance

- Review monitor logs weekly for patterns
- Adjust heartbeat intervals based on criticality
- Update success conditions if health response format changes
- Rotate webhook logs monthly
