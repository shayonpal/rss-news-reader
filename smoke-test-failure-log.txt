Run echo "Running critical path tests..."
  echo "Running critical path tests..."
  # First run environment smoke test to validate setup
  if [ -f "src/__tests__/unit/test-setup.smoke.test.ts" ]; then
    echo "Running environment smoke test..."
    npx vitest run --no-coverage \
      src/__tests__/unit/test-setup.smoke.test.ts \
      --reporter=verbose || echo "Smoke test not found, skipping..."
  fi

  # Use the isolation script for critical tests to prevent cross-test interference
  echo "Running critical tests with proper isolation..."
  chmod +x scripts/run-critical-tests.sh
  ./scripts/run-critical-tests.sh
  echo "Critical path tests passed ✅"
  shell: /usr/bin/bash -e {0}
  env:
    NODE_VERSION: 20
    PNPM_VERSION: 8
    CI: true
    FORCE_COLOR: 1
Running critical path tests...
Running environment smoke test...
The CJS build of Vite's Node API is deprecated. See https://vite.dev/guide/troubleshooting.html#vite-cjs-node-api-deprecated for more details.

 RUN  v2.1.9 /home/runner/work/rss-news-reader/rss-news-reader

 ✓ src/__tests__/unit/test-setup.smoke.test.ts > Test Environment Smoke Test > should have IndexedDB available
 ✓ src/__tests__/unit/test-setup.smoke.test.ts > Test Environment Smoke Test > should have localStorage available
 ✓ src/__tests__/unit/test-setup.smoke.test.ts > Test Environment Smoke Test > should have sessionStorage available
 ✓ src/__tests__/unit/test-setup.smoke.test.ts > Test Environment Smoke Test > should have fetch available
 ✓ src/__tests__/unit/test-setup.smoke.test.ts > Test Environment Smoke Test > should have IntersectionObserver available
 ✓ src/__tests__/unit/test-setup.smoke.test.ts > Test Environment Smoke Test > should have ResizeObserver available
 ✓ src/__tests__/unit/test-setup.smoke.test.ts > Test Environment Smoke Test > should have matchMedia available
 ✓ src/__tests__/unit/test-setup.smoke.test.ts > Test Environment Smoke Test > should be able to use storage APIs
 ✓ src/__tests__/unit/test-setup.smoke.test.ts > Test Environment Smoke Test > should be able to clear storage

 Test Files  1 passed (1)
      Tests  9 passed (9)
   Start at  21:31:49
   Duration  897ms (transform 54ms, setup 48ms, collect 14ms, tests 6ms, environment 399ms, prepare 63ms)

Running critical tests with proper isolation...
Running critical path tests with isolation...
1. Running database lifecycle tests...
The CJS build of Vite's Node API is deprecated. See https://vite.dev/guide/troubleshooting.html#vite-cjs-node-api-deprecated for more details.

 RUN  v2.1.9 /home/runner/work/rss-news-reader/rss-news-reader

 ✓ src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Category 1: Database Open/Close Behavior (6 tests) > 1.1 should open database successfully
 ✓ src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Category 1: Database Open/Close Behavior (6 tests) > 1.2 should handle opening already-open database
 ✓ src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Category 1: Database Open/Close Behavior (6 tests) > 1.3 should close and reopen database (close → open sequence)
 ✓ src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Category 1: Database Open/Close Behavior (6 tests) > 1.4 should handle simultaneous close calls without errors
 ✓ src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Category 1: Database Open/Close Behavior (6 tests) > 1.5 should perform read/write operations after open-close-reopen cycle
stderr | src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Category 2: Deletion Edge Cases (6 tests) > 2.2 should handle deleting database that is still open
Database version changed by another tab. Reloading...
Another connection wants to delete database 'test_db_delete_open_test_1754947912214_1axeiu'. Closing db now to resume the delete request.

 ✓ src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Category 1: Database Open/Close Behavior (6 tests) > 1.6 should handle multiple database instances in parallel
 ✓ src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Category 2: Deletion Edge Cases (6 tests) > 2.1 should close and delete database successfully (close → delete sequence)
 ✓ src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Category 2: Deletion Edge Cases (6 tests) > 2.2 should handle deleting database that is still open
 ✓ src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Category 2: Deletion Edge Cases (6 tests) > 2.3 should handle close → delete → open sequence creating new clean database
 ✓ src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Category 2: Deletion Edge Cases (6 tests) > 2.4 should handle deleting non-existent database
 ✓ src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Category 2: Deletion Edge Cases (6 tests) > 2.5 should handle rapid close → delete sequence
 ✓ src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Category 2: Deletion Edge Cases (6 tests) > 2.6 should handle delete with simulated slow file removal
 ✓ src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Category 3: Concurrency/Race Conditions (8 tests) > 3.1 should handle concurrent close and delete from separate async routines
 ✓ src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Category 3: Concurrency/Race Conditions (8 tests) > 3.2 should handle multiple parallel open/close/delete operations
 ✓ src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Category 3: Concurrency/Race Conditions (8 tests) > 3.3 should handle two connections to same database with concurrent cleanup
 ✓ src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Category 3: Concurrency/Race Conditions (8 tests) > 3.4 should handle database deletion while transaction is pending
 ✓ src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Category 3: Concurrency/Race Conditions (8 tests) > 3.5 should handle rapid open/close cycles under load
 ✓ src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Category 3: Concurrency/Race Conditions (8 tests) > 3.6 should handle interleaved open/close operations from multiple databases
 ✓ src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Category 3: Concurrency/Race Conditions (8 tests) > 3.7 should handle database recreation race conditions
 ✓ src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Category 3: Concurrency/Race Conditions (8 tests) > 3.8 should prevent DatabaseClosedError during concurrent operations
 ✓ src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Category 4: Resource Management (5 tests) > 4.1 should handle open/close in tight loop without resource leaks
 ✓ src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Category 4: Resource Management (5 tests) > 4.2 should handle databases with increasing complexity
 ✓ src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Category 4: Resource Management (5 tests) > 4.3 should verify no lingering IndexedDB connections after cleanup
 ✓ src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Category 4: Resource Management (5 tests) > 4.4 should handle repeated create/drop of unique databases
 ✓ src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Category 4: Resource Management (5 tests) > 4.5 should handle resource cleanup after operation timeout/abort
 ✓ src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Category 5: Multi-Test Isolation (5 tests) > 5.1 should use unique database names per test preventing cross-test pollution
 ✓ src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Category 5: Multi-Test Isolation (5 tests) > 5.2 should verify database no longer exists after cleanup
 ✓ src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Category 5: Multi-Test Isolation (5 tests) > 5.3 should run parallel tests with different DB names without interference
 ✓ src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Category 5: Multi-Test Isolation (5 tests) > 5.4 should handle same DB name with explicit close+delete between runs
 ✓ src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Category 5: Multi-Test Isolation (5 tests) > 5.5 should verify data stores don't auto-initialize in test environment
 ✓ src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Integration Tests: Complete Lifecycle Scenarios > should handle complete application startup/shutdown cycle
 ✓ src/lib/stores/__tests__/database-lifecycle.test.ts > RR-112: Database Lifecycle Management and Race Condition Tests > Integration Tests: Complete Lifecycle Scenarios > should handle database corruption recovery scenario

 Test Files  1 passed (1)
      Tests  32 passed (32)
   Start at  21:31:51
   Duration  1.51s (transform 155ms, setup 50ms, collect 179ms, tests 458ms, environment 388ms, prepare 70ms)

2. Running data store tests...
The CJS build of Vite's Node API is deprecated. See https://vite.dev/guide/troubleshooting.html#vite-cjs-node-api-deprecated for more details.

 RUN  v2.1.9 /home/runner/work/rss-news-reader/rss-news-reader

stdout | src/lib/stores/__tests__/data-stores.test.ts > Data Stores Integration Tests > Article Store Tests > should load articles correctly
Initializing database...

stdout | src/lib/stores/__tests__/data-stores.test.ts > Data Stores Integration Tests
stderr | src/lib/stores/__tests__/data-stores.test.ts > Data Stores Integration Tests
Database validation failed: TypeError: Cannot read properties of undefined (reading 'toArray')
Initialized default user preferences
Database initialized successfully

    at Function.validateDatabaseIntegrity (/home/runner/work/rss-news-reader/rss-news-reader/src/lib/db/migrations.ts:223:42)
    at Object.initializeDatabase (/home/runner/work/rss-news-reader/rss-news-reader/src/lib/stores/data-store.ts:86:38)
    at runNextTicks (node:internal/process/task_queues:60:5)
    at processImmediate (node:internal/timers:454:9)
    at /home/runner/work/rss-news-reader/rss-news-reader/src/lib/stores/__tests__/data-stores.test.ts:215:22
    at file:///home/runner/work/rss-news-reader/rss-news-reader/node_modules/@vitest/runner/dist/index.js:533:5
    at runTest (file:///home/runner/work/rss-news-reader/rss-news-reader/node_modules/@vitest/runner/dist/index.js:1056:11)
    at async Promise.all (index 0)
    at runSuite (file:///home/runner/work/rss-news-reader/rss-news-reader/node_modules/@vitest/runner/dist/index.js:1191:13)
    at async Promise.all (index 0)
Failed to get user preferences: TypeError: Cannot read properties of undefined (reading 'orderBy')
    at UserPreferencesRepository.getPreferences (/home/runner/work/rss-news-reader/rss-news-reader/src/lib/db/repositories/user-preferences-repository.ts:16:48)
    at Object.loadPreferences (/home/runner/work/rss-news-reader/rss-news-reader/src/lib/stores/data-store.ts:134:45)
    at Object.initializeDatabase (/home/runner/work/rss-news-reader/rss-news-reader/src/lib/stores/data-store.ts:104:23)
    at runNextTicks (node:internal/process/task_queues:60:5)
    at processImmediate (node:internal/timers:454:9)
    at /home/runner/work/rss-news-reader/rss-news-reader/src/lib/stores/__tests__/data-stores.test.ts:215:22
    at file:///home/runner/work/rss-news-reader/rss-news-reader/node_modules/@vitest/runner/dist/index.js:533:5
    at runTest (file:///home/runner/work/rss-news-reader/rss-news-reader/node_modules/@vitest/runner/dist/index.js:1056:11)
    at async Promise.all (index 0)
    at runSuite (file:///home/runner/work/rss-news-reader/rss-news-reader/node_modules/@vitest/runner/dist/index.js:1191:13)
Failed to get today's usage: TypeError: Cannot read properties of undefined (reading 'where')
    at ApiUsageRepository.getTodaysUsage (/home/runner/work/rss-news-reader/rss-news-reader/src/lib/db/repositories/api-usage-repository.ts:9:39)
    at Object.loadApiUsage (/home/runner/work/rss-news-reader/rss-news-reader/src/lib/stores/data-store.ts:210:50)
    at Object.initializeDatabase (/home/runner/work/rss-news-reader/rss-news-reader/src/lib/stores/data-store.ts:105:23)
    at runNextTicks (node:internal/process/task_queues:60:5)
    at processImmediate (node:internal/timers:454:9)
    at /home/runner/work/rss-news-reader/rss-news-reader/src/lib/stores/__tests__/data-stores.test.ts:215:22
    at file:///home/runner/work/rss-news-reader/rss-news-reader/node_modules/@vitest/runner/dist/index.js:533:5
    at runTest (file:///home/runner/work/rss-news-reader/rss-news-reader/node_modules/@vitest/runner/dist/index.js:1056:11)
    at async Promise.all (index 0)
    at runSuite (file:///home/runner/work/rss-news-reader/rss-news-reader/node_modules/@vitest/runner/dist/index.js:1191:13)

 × src/lib/stores/__tests__/data-stores.test.ts > Data Stores Integration Tests > Database Initialization > should initialize database with correct schema
   → expected false to be true // Object.is equality
 ✓ src/lib/stores/__tests__/data-stores.test.ts > Data Stores Integration Tests > Database Initialization > should create all required tables
 × src/lib/stores/__tests__/data-stores.test.ts > Data Stores Integration Tests > Database Initialization > should handle database corruption gracefully
   → DatabaseClosedError Database has been closed
stderr | src/lib/stores/__tests__/data-stores.test.ts > Data Stores Integration Tests
Failed to initialize database: [DexieError [DatabaseClosedError]: DatabaseClosedError Database has been closed] {
  inner: [DexieError [DatabaseClosedError]: Database has been closed] {
    inner: null
  }
}

stdout | src/lib/stores/__tests__/data-stores.test.ts > Data Stores Integration Tests > Article Store Tests
📊 Database query - preservedArticles: 0, readStatusFilter: unread

 × src/lib/stores/__tests__/data-stores.test.ts > Data Stores Integration Tests > Article Store Tests > should filter articles by feed
   → DatabaseClosedError Database has been closed
 × src/lib/stores/__tests__/data-stores.test.ts > Data Stores Integration Tests > Database Initialization > should initialize database with correct schema
   → expected false to be true // Object.is equality
 × src/lib/stores/__tests__/data-stores.test.ts > Data Stores Integration Tests > Article Store Tests > should load articles correctly
   → expected +0 to be 1 // Object.is equality

⎯⎯⎯⎯⎯⎯⎯ Failed Tests 4 ⎯⎯⎯⎯⎯⎯⎯

 FAIL  src/lib/stores/__tests__/data-stores.test.ts > Data Stores Integration Tests > Database Initialization > should initialize database with correct schema
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 ❯ src/lib/stores/__tests__/data-stores.test.ts:218:48
    216|
    217|       expect(result).toBe(true);
    218|       expect(dataStore.dbStatus.isInitialized).toBe(true);
       |                                                ^
    219|       expect(dataStore.dbStatus.isHealthy).toBe(true);
    220|     });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/4]⎯

 FAIL  src/lib/stores/__tests__/data-stores.test.ts > Data Stores Integration Tests > Database Initialization > should handle database corruption gracefully
DatabaseClosedError: DatabaseClosedError Database has been closed
⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯
Serialized Error: { inner: { name: 'DatabaseClosedError', message: 'Database has been closed', inner: null, constructor: 'Function<DexieError>', toString: 'Function<toString>' } }
⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[2/4]⎯

 FAIL  src/lib/stores/__tests__/data-stores.test.ts > Data Stores Integration Tests > Article Store Tests > should load articles correctly
AssertionError: expected +0 to be 1 // Object.is equality

- Expected
+ Received

- 1
+ 0

 ❯ src/lib/stores/__tests__/data-stores.test.ts:258:42
    256|       await articleStore.loadArticles();
    257|
    258|       expect(articleStore.articles.size).toBe(1);
       |                                          ^
    259|       expect(articleStore.articles.get("test-article-1")).toBeDefined(…
    260|       expect(articleStore.loadingArticles).toBe(false);

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[3/4]⎯

 FAIL  src/lib/stores/__tests__/data-stores.test.ts > Data Stores Integration Tests > Article Store Tests > should filter articles by feed
DatabaseClosedError: DatabaseClosedError Database has been closed
⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯
Serialized Error: { inner: { name: 'DatabaseClosedError', message: 'Database has been closed', inner: null, constructor: 'Function<DexieError>', toString: 'Function<toString>' } }
⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[4/4]⎯

 Test Files  1 failed (1)
      Tests  4 failed | 1 passed (24)
   Start at  21:31:53
   Duration  1.20s (transform 231ms, setup 47ms, collect 276ms, tests 65ms, environment 389ms, prepare 62ms)

Error: Process completed with exit code 1.
